name: release

on:
  push:
    branches: [ master, dev ]
    tags: [ 'v*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Install dependencies
      run: |
        sudo apt-get -y install libxml2-utils rpm
    - name: Initialize Graylog
      run: |
        export GRAYLOG_VERSION=$(xmllint --xpath '/*[local-name()="project"]/*[local-name()="parent"]/*[local-name()="version"]/text()' pom.xml)
        echo "Checking out Graylog ${GRAYLOG_VERSION}"
        git clone --depth 1 --branch "${GRAYLOG_VERSION}" https://github.com/Graylog2/graylog2-server.git ../graylog2-server
        pushd ../graylog2-server
        mvn generate-resources -pl graylog2-server -B -V
        popd
    - name: Build
      run: mvn -B package --file pom.xml
    - name: Package deb
      run: mvn jdeb:jdeb
    - name: Package rpm
      run: mvn rpm:rpm
    - name: Cleanup
      run: rm -f target/original-*.jar
    - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/*.jar
            target/*.deb
            target/*.rpm
          body: |
            This release **requires Graylog X.X.X or later**
            
            To update the plugin you need to remove the old `telegram-alert-x.x.x.jar` file from your plugins folder and follow the [installation instructions](https://github.com/irgendwr/TelegramAlert#installation) again.
            
            ## Changelog
            
            - XXX
            
            ---
            
            In case you like this plugin I would be happy if you could star ‚≠êÔ∏è this repository to keep me motivated üòÑ
            If you want to support my work directly, you can also [sponsor me on GitHub](https://github.com/sponsors/irgendwr).
            
            TelegramAlert currently has XXX ‚≠ê stars.
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
